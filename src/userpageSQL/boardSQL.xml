<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="board">

	<!-- 전체 게시물 카운트 -->
	<select id="userGetArticleCount" resultType="int" parameterType="String">
		select count(*) from otoboard A,(select otonum from otoboard where writer=#{user_id}) B where A.otonum = B.otonum
	</select>

	<!-- 전체 게시물 조회 -->
	<select id="userGetArticles" resultType="otoDTO" parameterType="HashMap">
		select num,writer,ph,subject,passwd,reg_date,ref,re_step,re_level,content,ip,readcount,r 
					from (select num,writer,ph,subject,passwd,reg_date,ref,re_step,re_level,content,ip,readcount,rownum r 
					from (select num,writer,ph,subject,passwd,reg_date,ref,re_step,re_level,content,ip,readcount 
					from (select * 
					from otoboard A,(select otonum from otoboard where writer=#{user_id}) B where A.otonum = B.otonum) order by ref asc, re_level asc) order by ref asc, re_level asc ) 
					<![CDATA[where r >= #{startRow} and r <= #{endRow}]]>
	</select>

	<!-- 게시물 조회수 증가 -->
	<update id="updateNum" parameterType="int">
		update otoboard set readcount=readcount+1 where num = #{num}
	</update>

	<!-- 글번호 가져오기 -->
	<select id="getArticlesNum" resultType="otoDTO" parameterType="int">
		select * from otoboard where num=#{num}
	</select>
	
	<!-- max(num) 뽑기 -->
	<select id="maxnum" parameterType="HashMap">
		select max(num) from otoboard
	</select>
	
	<!-- 업데이트 -->
	<insert id="insertArticles" parameterType="otoDTO">
		insert into otoboard(num,writer,email,ph,subject,passwd,save,reg_date,
		ref,re_step,re_level,content,ip,otonum) values(otoboard_seq.NEXTVAL,#{writer},#{email},#{ph},#{subject},#{passwd},#{save},#{reg_date},#{ref},{#re_step},#{re_level},#{content},#{ip},otonum_seq.NEXTVAL)
	</insert>
	
	<!-- 답글시 증가 -->
	<update id="readCountUp" parameterType="otoDTO">
		update otoboard set re_step=re_step+1 where ref= #{ref} and re_step> #{re_step}
	</update>
	
	<!-- user id에 따른 otonum 가져오기 -->
	<select id="getOtonum" resultType="otoDTO">
		select count(*) from otoboard A,(select otonum from otoboard where writer=#{user_id}) B where A.otonum = B.otonum
	</select>
	
</mapper>